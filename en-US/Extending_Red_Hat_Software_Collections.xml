<?xml version="1.0"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="chap-Extending_Red_Hat_Software_Collections">
  <title>Extending Red Hat Software Collections 1.1 Beta</title>
  <section id="sect-Extending_the_python27_and_python33_Software_Collections">
    <title>Extending the python27 and python33 &DSCL;s</title>
    <para>
      In Red Hat Software Collections 1.1 Beta, the <application>scl</application> tool has been extended to support a macro <systemitem>%scl_package_override()</systemitem>, which allows for easier packaging of your own dependent &DSCL;.
    </para>
    <para>
      Note that even though the approach described below generally applies to every &DSCL; shipped with Red Hat Software Collections 1.1 Beta, there are specifics that depend on the &DSCL; you are extending.
    </para>
    <section id="The_vt191_Software_Collection">
    <title>The vt191 &DSCL;</title>
    <para>
      Below is a commented example of building a dependent &DSCL;. The &DSCL; is named <literal>vt191</literal> and contains the <package>versiontools</package> Python package version 1.9.1.
    </para>
    <para>
      Note the following in the vt191 &DSCL; spec file:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          The vt191 &DSCL; spec file has the following build dependency set:
        </para>
        <programlisting language="RPM Spec">BuildRequires: %{scl_prefix_python}scldevel</programlisting>
        <para>
          This expands to, for example, <package>python27-scldevel</package>.
        </para>
        <para>
          The <package>python27-scldevel</package> package ships two important macros, <code>%scl_python</code> and <code>%scl_prefix_python</code>. Note that these macros are defined at the top of the spec file. The definitions are not required, they only provide a hint that the vt191 &DSCL; has been designed to be built on top of the python27 &DSCL;. They also serve as a fallback value.
        </para>
      </listitem>
      <listitem>
        <para>
          To have a <filename>site-packages</filename> directory set up properly, use the value of the <code>%python27python_sitelib</code> macro and replace <code>python27</code> with <code>vt191</code>. Note that if
  you are building the &DSCL; with a different provider (for example, <filename>/opt/myorganization/</filename> instead of <filename>/opt/rh/</filename>), you will need to change these, too.
        </para>
        <important>
          <para>
            Because the <filename>/opt/rh/</filename> provider is used to install &DSCL;s provided by Red Hat, it is strongly recommended to use a different provider to avoid possible conflicts. See <xref linkend="sect-The_Software_Collection_Root_Directory" /> for more information.
          </para>
        </important>
      </listitem>
      <listitem>
        <para>
          The <package>vt191-build</package> subpackage has the following dependency set:
        </para>
        <programlisting language="RPM Spec">Requires: %{scl_prefix_python}scldevel</programlisting>
        <para>
          This expands to, for example, <package>python27-scldevel</package>. The purpose of this dependency is to ensure that the macros are always present when building packages for the vt191 &DSCL;.
        </para>
      </listitem>
      <listitem>
        <para>
          The <filename>enable</filename> scriptlet for the vt191 &DSCL; uses the following line:
        </para>
        <programlisting language="RPM Spec">. scl_source enable %{scl_python}</programlisting>
        <para>
          This makes the Python &DSCL; start implicitly when the vt191 &DSCL; is started so that the user can only type <command>scl enable vt191 <replaceable>command</replaceable></command> instead of <command>scl enable python27 vt191 <replaceable>command</replaceable></command> to run <replaceable>command</replaceable> in the &DSCL; environment.
        </para>
      </listitem>
      <listitem>
        <para>
          The macro file <filename>macros.vt191-config</filename> calls the <code>%scl_package_override</code> function to properly override <code>%__os_install_post</code>, Python dependency generators, and certain Python-specific macros used in other packages' spec files.
        </para>
      </listitem>
    </itemizedlist>
<programlisting language="RPM Spec"><![CDATA[# define name of the scl
%global scl vt191
%scl_package %scl

# Defaults for the values for the python27/python33 Software Collection. These
# will be used when python27-scldevel (or python33-scldevel) is not in the
# buildroot
%{!?scl_python:%global scl_python python27}
%{!?scl_prefix_python:%global scl_prefix_python %{scl_python}-}

# Only for this build, you need to override default __os_install_post,
# because the default one would find /opt/.../lib/python2.7/ and try
# to bytecompile with the system /usr/bin/python2.7
%global __os_install_post %{%{scl_python}_os_install_post}
# Similarly, override __python_requires for automatic dependency generator
%global __python_requires %{%{scl_python}_python_requires}

# The directory for site packages for this Software Collection
%global vt191_sitelib %(echo %{python27python_sitelib} | sed 's|%{scl_python}|%{scl}|')

Summary: Package that installs %scl
Name: %scl_name
Version: 1
Release: 1%{?dist}
License: GPLv2+
BuildRequires: scl-utils-build
# Always make sure that there is the python27-sclbuild (or python33-sclbuild)
# package in the buildroot
BuildRequires: %{scl_prefix_python}scldevel
# Require python27-python-devel, you will need macros from that package
BuildRequires: %{scl_prefix_python}python-devel
Requires: %{scl_prefix}python-versiontools

%description
This is the main package for %scl Software Collection.

%package runtime
Summary: Package that handles %scl Software Collection.
Requires: scl-utils
Requires: %{scl_prefix_python}runtime

%description runtime
Package shipping essential scripts to work with %scl Software Collection.

%package build
Summary: Package shipping basic build configuration
Requires: scl-utils-build
# Require python27-scldevel (or python33-scldevel) so that there is always access
# to the %%scl_python and %%scl_prefix_python macros in builds for this Software
# Collection
Requires: %{scl_prefix_python}scldevel

%description build
Package shipping essential configuration macros to build %scl Software Collection.

%install
%scl_install

# Create the enable scriptlet that:
# - Adds an additional load path for the Python interpreter.
# - Runs scl_source so that you can run:
#     scl enable vt191 "bash"
#   instead of:
#     scl enable python27 vt191 "bash"

cat >> %{buildroot}%{_scl_scripts}/enable << EOF
. scl_source enable %{scl_python}
export PYTHONPATH=%{vt191_sitelib}\${PYTHONPATH:+:\${PYTHONPATH}}
EOF

mkdir -p %{buildroot}%{vt191_sitelib}

# - Enable Software Collection-specific bytecompilation macros from
#   the python27-python-devel package.
# - Also override the %%python_sitelib macro to point to the vt191 Software
#   Collection.
# - If you have architecture-dependent packages, you will also need to override
#   the %%python_sitearch macro.

cat >> %{buildroot}%{_root_sysconfdir}/rpm/macros.%{scl}-config << EOF
%%scl_package_override() %%{expand:%{?python27_os_install_post:%%global __os_install_post %%python27_os_install_post}
%%global __python_requires %%python27_python_requires
%%global __python_provides %%python27_python_provides
%%global __python %python27__python
%%global python_sitelib %vt191_sitelib
%%global python2_sitelib %vt191_sitelib
}
EOF

%files

%files runtime -f filesystem
%scl_files
%vt191_sitelib

%files build
%{_root_sysconfdir}/rpm/macros.%{scl}-config

%changelog
* Wed Jan 22 2014 John Doe <jdoe@example.com> - 1-1
- Initial package.]]></programlisting>
    </section>
    <section id="sect-The_python-versiontools_Package">
    <title>The python-versiontools Package</title>
    <para>
      Below is a commented example of the <package>python-versiontools</package> package spec file. Note the following in the spec file:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          The <code>BuildRequires</code> tags are prefixed with <code>%{?scl_prefix_python}</code> instead of <code>%{scl_prefix}</code>.
        </para>
      </listitem>
      <listitem>
        <para>
          The <code>%install</code> section explictly specifies <code>--install-purelib</code>.
        </para>
      </listitem>
    </itemizedlist>
<programlisting language="RPM Spec"><![CDATA[%{?scl:%scl_package python-versiontools}
%{!?scl:%global pkg_name %{name}}

%global pypi_name versiontools

Name:           %{?scl_prefix}python-versiontools
Version:        1.9.1
Release:        1%{?dist}
Summary:        Smart replacement for plain tuple used in __version__

License:        LGPLv3
URL:            https://launchpad.net/versiontools
Source0:        http://pypi.python.org/packages/source/v/versiontools/versiontools-1.9.1.tar.gz

BuildArch:      noarch
BuildRequires:  %{?scl_prefix_python}python-devel
BuildRequires:  %{?scl_prefix_python}python-setuptools
%{?scl:BuildRequires: %{scl}-build %{scl}-runtime}
%{?scl:Requires: %{scl}-runtime}

%description
Smart replacement for plain tuple used in __version__

%prep
%setup -q -n %{pypi_name}-%{version}

%build
%{?scl:scl enable %{scl} "}
%{__python} setup.py build
%{?scl:"}

%install
# Explicitly specify --install-purelib %{python_sitelib}, which is now overriden
# to point to vt191, otherwise Python will try to install into the python27
# Software Collection site-packages directory
%{?scl:scl enable %{scl} "}
%{__python} setup.py install -O1 --skip-build --root %{buildroot} --install-purelib %{python_sitelib}
%{?scl:"}

%files
%{python_sitelib}/%{pypi_name}*

%changelog
* Wed Jan 22 2014 John Doe <jdoe@example.com> - 1.9.1-1
- Built for vt191 SCL.]]></programlisting>
    </section>
    <section id="sect-Building_the_vt191_Software_Collection">
    <title>Building the vt191 &DSCL;</title>
    <para>
      To build the vt191 &DSCL;:
    </para>
    <procedure>
      <step>
        <para>
          Install the <package>python27-scldevel</package> and <package>python27-python-devel</package> packages that are part of Red Hat Software Collections.
        </para>
      </step>
      <step>
        <para>
          Build <filename>vt191.spec</filename> and install the <package>vt191-runtime</package> and <package>vt191-build</package> packages.
        </para>
      </step>
      <step>
        <para>
          Install the <package>python27-python-setuptools</package> package, which is a build requirement for <package>versiontools</package>.
        </para>
      </step>
      <step>
        <para>
          Build <filename>python-versiontools.spec</filename>.
        </para>
      </step>
    </procedure>
    </section>
    <section id="Testing_the_vt191_Software_Collection">
    <title>Testing the vt191 &DSCL;</title>
    <para>
      To test the vt191 &DSCL;:
    </para>
    <procedure>
      <step>
        <para>
          Install the <package>vt191-python-versiontools</package> package.
        </para>
      </step>
      <step>
        <para>
          Run the following command:
        </para>
        <screen><computeroutput>$ </computeroutput><userinput>scl enable vt191 "python -c 'import versiontools; print(versiontools.__file__)'"</userinput></screen>
        <para>The output should contain the following line:</para>
        <screen>/opt/rh/vt191/root/usr/lib/python2.7/site-packages/versiontools/__init__.pyc</screen>
        <para>
          Note that the provider <filename>rh</filename> in the path may vary depending on your redefinition of the <code>%_scl_prefix</code> macro. See <xref linkend="sect-The_Software_Collection_Root_Directory" /> for more information.
        </para>
      </step>
    </procedure>
    </section>
  </section>
</chapter>
